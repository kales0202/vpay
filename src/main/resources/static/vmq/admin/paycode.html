<style>
    #table-pay-code {
        margin-top: 20px;
    }

    .pay-code-btn {
        background-color: #16baaa;
        color: #fff !important;
    }
</style>

<input autocomplete="off" class="layui-input" name="A" placeholder="search is not ready" type="text" value="">
<table id="table-pay-code" lay-filter="pay-code-table-filter"></table>

<script id="table-pay-code-enabled" type="text/html">
    <input id="pay-code-enabled" type="checkbox" name="enabled" value="{{= d.id }}" title="开|关" lay-skin="switch"
           lay-filter="table-templet-enabled" {{=d.enabled == true ? "checked" : "" }}>
</script>

<script id="pay-code-toolbar" type="text/html">
    <div>
        <div class="pay-code-btn layui-inline" title="新增数据" lay-event="add-pay-code"><i
                class="layui-icon layui-icon-add-1"></i></div>
    </div>
</script>

<script id="pay-code-bar" type="text/html">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del-pay-code">删除</a>
</script>

<script>
    layui.use(function () {
        var table = layui.table;
        var form = layui.form;
        var util = layui.util;

        // 获取当前所在行
        table.getRowIndex = function (tableId, elem) {
            return $(elem).closest('tr').data('index');
        };

        // 获取当前行数据
        table.getRowData = function (tableId, elem) {
            var index = table.getRowIndex(tableId, elem);
            return table.cache[tableId][index] || {};
        };

        // 创建表格实例
        table.render({
            elem: '#table-pay-code',
            url: '/pay-code/list',
            method: "post",
            parseData: function (res) { // res 即为原始返回的数据
                if (res.code === -2) {
                    API.navigate2Login();
                }
                return res;
            },
            toolbar: '#pay-code-toolbar',
            editTrigger: 'dblclick', // 触发编辑的事件类型（默认 click ）。 v2.7.0 新增，之前版本固定为单击触发
            cols: [[
                {field: 'name', title: '名称', edit: 'editable'},
                {
                    field: 'payType',
                    title: '类型',
                    templet: function (d) {
                        if (d.payType === 1) {
                            return '微信';
                        } else if (d.payType === 2) {
                            return '支付宝';
                        }
                        return d.payType;
                    }
                },
                {
                    field: 'content',
                    title: '付款码',
                    align: "center",
                    templet: '<img class="pay-code-qricon" style="height: 1em" src="./image/qrcode-icon.svg" alt="Description of SVG" />\n'
                },
                {field: 'weight', title: '权重', edit: 'editable'},
                {
                    field: 'createTime',
                    title: '创建时间',
                    minWidth: 160,
                    templet: function (d) {
                        return Util.formatTime(d.createTime);
                    }
                },
                {title: '状态', width: 85, templet: '#table-pay-code-enabled'},
                {title: '操作', minWidth: 120, align: 'center', toolbar: '#pay-code-bar'}
            ]],
            page: false,
            done: function (res, curr, count, origin) {
                var options = this;

                // 状态 - 开关操作
                form.on('switch(table-templet-enabled)', function (obj) {
                    var data = table.getRowData(options.id, obj.elem);
                    API.modifyPayCode({id: this.value, enabled: obj.elem.checked},
                        function () {
                            data.enabled = obj.elem.checked;
                            layer.msg('修改成功');
                        },
                        function () {
                            obj.elem.checked = !obj.elem.checked;
                            form.render($('#pay-code-enabled'));
                            layer.msg('修改失败！');
                        }
                    );
                });

                // 监听工具栏事件
                table.on('toolbar(pay-code-table-filter)', function (obj) {
                    console.log("event: ", obj.event);
                    switch (obj.event) {
                        // 新增付款码
                        case 'add-pay-code':
                            openPayCodePage();
                            break;
                    }
                });

                //监听行工具事件
                table.on('tool(pay-code-table-filter)', function (obj) {
                    console.log("event: ", obj.event);
                    switch (obj.event) {
                        case 'del-pay-code':
                            layer.confirm('确定删除该付款码？', {icon: 3}, function () {
                                API.deletePayCode({id: obj.data.id}, function (data) {
                                    layer.msg('删除成功');
                                    // 数据重载 - 仅与数据相关的属性(options)能参与到重载中
                                    table.reloadData('table-pay-code', {
                                        // where: {}, // 数据异步请求时携带的字段集
                                        scrollPos: true, // 设定重载数据或切换分页时的滚动条的位置状态
                                    });
                                });
                            });
                            break;
                    }
                });

                var $payCodeShow = $("#pay-code-show")
                var qriconHoverTimeout;
                $('.pay-code-qricon').hover(function () {
                    var _this = this;
                    qriconHoverTimeout = setTimeout(function () {
                        var data = table.getRowData(options.id, _this);
                        console.log("show qr code: ", data.content);
                        Util.encodeQRCode($payCodeShow, data.content);
                        layer.tips($payCodeShow.html(), _this, {
                            tips: [1, '#FFFFFF'],
                            time: 0, // 设置时间为0，使提示框持续显示直到鼠标离开
                        });
                    }, 500);
                }, function () {
                    // 鼠标离开图片时执行的事件
                    clearTimeout(qriconHoverTimeout);
                    layer.closeAll('tips');
                });
            },
        });

        // 单元格编辑后的事件
        table.on('edit(pay-code-table-filter)', function (obj) {
            var _this = this;
            var field = obj.field; // 得到修改的字段
            var value = obj.value // 得到修改后的值
            var oldValue = obj.oldValue // 得到修改前的值 -- v2.8.0 新增
            var data = obj.data // 得到所在行所有键值

            // 值的校验
            if (value.replace(/\s/g, '') === '') {
                layer.tips('值不能为空', this, {tips: 1});
                return obj.reedit(); // 重新编辑 -- v2.8.0 新增
            }

            // 权重只能为正整数
            if (field === 'weight') {
                if (!/^[1-9]\d*$/.test(value)) {
                    layer.tips('权重只能为正整数', this, {tips: 1});
                    return obj.reedit(); // 重新编辑 -- v2.8.0 新增
                }
                value = parseInt(value);
            }

            var params = {id: data.id};
            params[field] = util.escape(value);
            API.modifyPayCode(params,
                function (data) {
                    layer.msg('修改成功');
                },
                function (res) {
                    layer.tips(res.msg, _this, {tips: 1});
                    params[field] = oldValue;
                    table.updateRow('table-pay-code', {index: obj.index, data: params});
                }
            );
        });

        var $payCodeContent = $('#pay-code-content');

        function openPayCodePage() {
            layer.open({
                type: 1,
                title: '付款码',
                shade: 0.8,
                area: ['520px', 'auto'],
                content: $payCodeContent,
                btn: ['取消', '保存'],
                btn1: function (index, layero, that) {
                    console.log("取消...");
                    layer.close(index);
                },
                btn2: function (index, layero, that) {
                    console.log("保存...");
                    savePayCode(function (data) {
                        // 数据重载 - 仅与数据相关的属性(options)能参与到重载中
                        table.reloadData('table-pay-code', {
                            // where: {}, // 数据异步请求时携带的字段集
                            scrollPos: true, // 设定重载数据或切换分页时的滚动条的位置状态
                        });
                        layer.close(index);
                    })

                    return false // 不关闭弹层
                },
                // 打开弹层成功后的回调函数
                success: function (layero, index, that) {
                    // 赋值
                    // form.val(filter, obj);

                    // 仅渲染 lay-filter="test" 的容器内的全部表单
                    // form.render(null, 'test');
                },
                end: function () {
                    $payCodeContent.hide();
                    resetPayCodeModel();
                    console.log('弹层已被移除');
                }
            })
        }

    });
</script>
