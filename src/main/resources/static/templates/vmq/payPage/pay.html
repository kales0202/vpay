<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="zh-cn" http-equiv="Content-Language">
    <meta content="no" name="apple-mobile-web-app-capable"/>
    <meta content="yes" name="apple-touch-fullscreen"/>
    <meta content="telephone=no,email=no" name="format-detection"/>
    <meta content="white" name="apple-mobile-web-app-status-bar-style">
    <meta content="webkit" name="renderer"/>
    <meta content="webkit" name="force-rendering"/>
    <meta content="IE=Edge,chrome=1" http-equiv="X-UA-Compatible"/>
    <meta content="0" http-equiv="Expires">
    <meta content="no-cache" http-equiv="Pragma">
    <meta content="no-cache" http-equiv="Cache-control">
    <meta content="no-cache" http-equiv="Cache">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <title>扫码支付</title>
    <link href="//unpkg.com/layui@2.9.6/dist/css/layui.css" rel="stylesheet">
    <link href="pay.css" media="screen" rel="stylesheet">
</head>

<body>
<div class="body" id="body">
    <h1 class="mod-title">
        <span class="ico_log"></span>
    </h1>
    <div class="mod-ct">
        <div id="timeout">
            <p>订单已过期，请您返回网站重新发起支付！</p><br>
        </div>
        <div id="order-content">
            <div class="really-price amount" id="money"></div>
            <div class="qrcode-img-wrapper" data-role="qrPayImgWrapper">
                <div class="qrcode-img-area" data-role="qrPayImg">
                    <div class="ui-loading qrcode-loading" data-role="qrPayImgLoading" style="display: none;">加载中
                    </div>
                    <div id="pay-url" style="position: relative;display: inline-block;"></div>
                </div>
            </div>
            <div class="time-item">
                <div class="time-item" id="msg">
                    <h1 class="price-diff-tips" style="display:none;">
                        <span style="color:red">为了您正常支付 请务必付款 <span class="really-price"></span> 元 <br>备注说明无需填写</span><br>
                    </h1>
                </div>
                <strong id="hour_show">0时</strong>
                <strong id="minute_show">0分</strong>
                <strong id="second_show">0秒</strong>
            </div>

            <div class="tip">
                <div class="ico-scan"></div>
                <div class="tip-text">
                    <p class="scan-tips"></p>
                    <p class="is-auto-tips">扫描二维码完成支付</p>
                </div>
            </div>

            <div class="detail" id="orderDetail">
                <dl class="detail-ct" id="desc" style="display: none;">
                    <dt>金额</dt>
                    <dd class="price"></dd>
                    <dt>商户订单：</dt>
                    <dd class="pay-id"></dd>
                    <dt>创建时间：</dt>
                    <dd class="create-time"></dd>
                    <dt>状态</dt>
                    <dd>等待支付</dd>
                </dl>
                <a class="arrow" href="javascript:void(0)" onclick="orderDetail()"><i class="ico-arrow"></i></a>
            </div>
        </div>
        <div class="tip-text"></div>
    </div>
    <div class="foot">
        <div class="inner">
            <p>手机用户可保存上方二维码到手机中</p>
            <p class="phone-pay-tips"></p>
        </div>
    </div>
</div>
<div class="copyRight"></div>

<script src="https://lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script>
<script src="//unpkg.com/layui@2.9.6/dist/layui.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/umd/zxing-browser.min.js"></script>
<script src="../js/util.js"></script>
<script src="../js/api.js"></script>

<script>
    var orderId = Util.getQueryString("orderId");
    var expiredTime = new Date().getTime() + 300000;
    var countdownId = -1;

    var $hourShow = $('#hour_show');
    var $minuteShow = $('#minute_show');
    var $secondShow = $('#second_show');

    API.getOrder({orderId: orderId}, function (data) {
        var payTypeText = data.payType === 1 ? '微信' : '支付宝';

        // 每秒更新一次倒计时
        var createTime = Util.toTimestamp(data.createTime);
        // expiredTime = createTime + data.close * 60 * 1000;
        countdownId = setInterval(countdown, 1000);

        $('.ico_log').addClass(data.payType === 1 ? 'ico-1' : 'ico-2');
        $('.really-price').html("￥" + data.reallyPrice);
        if (data.price !== data.reallyPrice) {
            $('.price-diff-tips').css("display", "block");
        }
        $('.scan-tips').html("请使用" + payTypeText + "扫一扫");
        $('.is-auto-tips').html(data.payType === 1 ? '扫描二维码完成支付' : '扫码后输入金额支付');
        $('.price').html(data.price);
        $('.pay-id').html(data.payId);
        $('.create-time').html(data.createTime);
        $('.phone-pay-tips').html("在" + payTypeText + "扫一扫中选择“相册”即可");
        Util.encodeQRCode($("#pay-url"), data.payUrl);
    });

    function countdown() {
        let now = new Date().getTime();
        let distance = expiredTime - now;

        if (distance < 0) {
            clearInterval(countdownId);
            countdownId = -1;
            qrcode_timeout();
        } else {
            let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = Math.floor((distance % (1000 * 60)) / 1000);
            $hourShow.html(hours + '时');
            $minuteShow.html(minutes + '分');
            $secondShow.html(seconds + '秒');

            // 每2秒向服务器请求一次订单状态
            if (distance % 2 === 0) {
                API.checkOrder({orderId: orderId},
                    function (data) {
                        window.location.href = data;
                    },
                    function (res) {
                        if (res.msg === "订单已过期") {
                            clearInterval(countdownId);
                            countdownId = -1;
                        }
                    }
                );
            }
        }
    }

    function orderDetail() {
        if ($('#orderDetail').hasClass('detail-open')) {
            $('#orderDetail .detail-ct').slideUp(500, function () {
                $('#orderDetail').removeClass('detail-open');
            });
        } else {
            $('#orderDetail .detail-ct').slideDown(500, function () {
                $('#orderDetail').addClass('detail-open');
            });
        }
    }

    function qrcode_timeout() {
        document.getElementById("order-content").style.display = "none";
        document.getElementById("timeout").style.display = "block";
    }
</script>
</body>
</html>